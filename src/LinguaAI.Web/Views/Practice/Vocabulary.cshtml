@{
    ViewData["Title"] = "Há»c Tá»« Vá»±ng";
    Layout = "_Layout";
}

<div class="container" style="padding-top: 100px;">
    <div class="text-center mb-4">
        <h1 class="text-gradient">ğŸ“š Há»c Tá»« Vá»±ng</h1>
        <p style="color: var(--text-secondary);">Há»c tá»« má»›i theo chá»§ Ä‘á» hoáº·c táº£i danh sÃ¡ch tá»« file</p>
    </div>

    <!-- Settings -->
    <div class="glass-panel text-center" style="padding: var(--space-lg); margin-bottom: var(--space-xl);">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; align-items: center;">
            <select id="languageSelect" class="input-field" style="width: auto;">
                <option value="ko">ğŸ‡°ğŸ‡· Tiáº¿ng HÃ n</option>
                <option value="zh">ğŸ‡¨ğŸ‡³ Tiáº¿ng Trung</option>
                <option value="en">ğŸ‡ºğŸ‡¸ Tiáº¿ng Anh</option>
            </select>
            <select id="themeSelect" class="input-field" style="width: auto;">
                <option value="greetings">ğŸ‘‹ ChÃ o há»i</option>
                <option value="numbers">ğŸ”¢ Sá»‘ Ä‘áº¿m</option>
                <option value="food">ğŸ• Äá»“ Äƒn</option>
                <option value="family">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Gia Ä‘Ã¬nh</option>
                <option value="colors">ğŸ¨ MÃ u sáº¯c</option>
                <option value="animals">ğŸ¾ Äá»™ng váº­t</option>
                <option value="weather">ğŸŒ¤ï¸ Thá»i tiáº¿t</option>
                <option value="shopping">ğŸ›’ Mua sáº¯m</option>
                <option value="travel">ğŸ§³ Du lá»‹ch</option>
                <option value="work">ğŸ’¼ CÃ´ng viá»‡c</option>
            </select>
            <button class="btn btn-primary" onclick="loadVocabulary()">ğŸ“š Táº£i tá»« AI</button>
        </div>
        
        <!-- File Upload Section -->
        <div style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--border-glass);">
            <p style="color: var(--text-secondary); margin-bottom: var(--space-md);">ğŸ“¤ Hoáº·c táº£i danh sÃ¡ch tá»« file cá»§a báº¡n</p>
            <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
                <input type="file" id="fileInput" accept=".xlsx,.docx" style="display: none;" onchange="handleFileUpload(event)">
                <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                    ğŸ“ Chá»n file Excel/Word
                </button>
                <span id="fileName" style="color: var(--text-muted); font-size: 0.9rem;"></span>
            </div>
            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: var(--space-sm);">
                Excel: Cá»™t A=Tá»«, B=NghÄ©a, C=PhÃ¡t Ã¢m, D=VÃ­ dá»¥ | Word: Tá»« - NghÄ©a (má»—i dÃ²ng)
            </p>
            <!-- Download Sample Files -->
            <div style="margin-top: var(--space-md); display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                <a href="~/samples/vocabulary_template.xlsx" 
                   class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;" download>
                    ğŸ“¥ Táº£i file máº«u Excel
                </a>
                <a href="~/samples/vocabulary_template.docx" 
                   class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;" download>
                    ğŸ“¥ Táº£i file máº«u Word
                </a>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingArea" class="hidden text-center" style="padding: var(--space-3xl);">
        <div class="spinner" style="margin: 0 auto var(--space-lg);"></div>
        <p style="color: var(--text-muted);">Äang xá»­ lÃ½...</p>
    </div>

    <!-- Mode Selection (appears after loading vocabulary) -->
    <div id="modeSelection" class="hidden text-center" style="margin-bottom: var(--space-xl);">
        <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            <button class="btn btn-primary mode-btn active" data-mode="flashcard" onclick="switchMode('flashcard')">
                ğŸƒ Flashcard
            </button>
            <button class="btn btn-secondary mode-btn" data-mode="quiz" onclick="switchMode('quiz')">
                ğŸ¤ Kiá»ƒm tra nÃ³i
            </button>
            <button class="btn btn-secondary mode-btn" data-mode="practice" onclick="switchMode('practice')">
                âœï¸ Luyá»‡n táº­p
            </button>
        </div>
        <!-- Display Language for Quiz -->
        <div id="quizDisplayLangSelector" class="hidden" style="margin-top: var(--space-lg);">
            <label style="color: var(--text-secondary); margin-right: var(--space-sm);">Hiá»ƒn thá»‹ nghÄ©a báº±ng:</label>
            <select id="displayLanguageSelect" class="input-field" style="width: auto; display: inline-block;">
                <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                <option value="en">ğŸ‡ºğŸ‡¸ Tiáº¿ng Anh</option>
                <option value="zh">ğŸ‡¨ğŸ‡³ Tiáº¿ng Trung</option>
            </select>
        </div>
    </div>

    <!-- Flashcard Area -->
    <div id="flashcardArea" class="hidden text-center">
        <!-- Source Badge -->
        <div id="sourceBadge" style="margin-bottom: var(--space-md);">
            <span class="lang-badge korean" id="sourceLabel">Tá»« AI</span>
        </div>

        <!-- Progress -->
        <div style="margin-bottom: var(--space-xl);">
            <span id="currentIndex" style="font-size: 1.5rem; font-weight: 600; color: var(--primary-light);">1</span>
            <span style="color: var(--text-muted);"> / </span>
            <span id="totalCount" style="font-size: 1.5rem; color: var(--text-muted);">10</span>
        </div>

        <!-- Flashcard -->
        <div class="flashcard-container" style="width: 400px; height: 280px;">
            <div class="flashcard" id="flashcard" onclick="flipCard()">
                <div class="flashcard-face flashcard-front">
                    <p class="flashcard-word" id="cardWord"></p>
                    <p class="flashcard-pronunciation" id="cardPronunciation"></p>
                </div>
                <div class="flashcard-face flashcard-back">
                    <p class="flashcard-meaning" id="cardMeaning"></p>
                    <p class="flashcard-example" id="cardExample"></p>
                </div>
            </div>
        </div>
        <p style="color: var(--text-muted); margin-top: var(--space-md);">Nháº¥n vÃ o tháº» Ä‘á»ƒ láº­t</p>

        <!-- Navigation -->
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: var(--space-xl);">
            <button class="btn btn-secondary" onclick="prevCard()">â¬…ï¸ TrÆ°á»›c</button>
            <button class="btn btn-secondary" onclick="shuffleCards()">ğŸ”€ Trá»™n</button>
            <button class="btn btn-primary" onclick="nextCard()">Tiáº¿p â¡ï¸</button>
        </div>

        <!-- Word List -->
        <div class="card" style="margin-top: var(--space-2xl); text-align: left;">
            <h3 class="mb-3">ğŸ“‹ Danh sÃ¡ch tá»« vá»±ng (<span id="wordCount">0</span> tá»«)</h3>
            <div id="wordList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-md);"></div>
        </div>
    </div>

    <!-- Speaking Quiz Area -->
    <div id="quizArea" class="hidden">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); max-width: 1000px; margin: 0 auto;">
            
            <!-- LEFT COLUMN: Question -->
            <div class="glass-panel" style="display: flex; flex-direction: column; justify-content: center; min-height: 400px; padding: var(--space-xl);">
                <!-- Quiz Progress -->
                <div style="margin-bottom: var(--space-lg); text-align: center;">
                    <span style="color: var(--text-secondary);">CÃ¢u há»i</span>
                    <span id="quizCurrentIndex" style="font-size: 1.5rem; font-weight: 600; color: var(--primary-light);">1</span>
                    <span style="color: var(--text-muted);"> / </span>
                    <span id="quizTotalCount" style="font-size: 1.5rem; color: var(--text-muted);">10</span>
                </div>

                <!-- Timer -->
                <div style="margin-bottom: var(--space-xl); text-align: center;">
                    <div id="timerDisplay" style="font-size: 3rem; font-weight: 700; color: var(--accent-gold);">10</div>
                    <div style="width: 200px; height: 8px; background: var(--bg-card); border-radius: 4px; margin: 0 auto; overflow: hidden;">
                        <div id="timerBar" style="width: 100%; height: 100%; background: var(--gradient-primary); transition: width 0.1s linear;"></div>
                    </div>
                </div>

                <!-- Meaning & Hint -->
                <div style="text-align: center;">
                    <p id="quizMeaningLabel" style="color: var(--text-muted); margin-bottom: var(--space-sm);">NghÄ©a tiáº¿ng Viá»‡t:</p>
                    <p id="quizMeaning" style="font-size: 2.5rem; font-weight: 700; color: var(--primary-text); line-height: 1.4;"></p>
                    <p id="quizHint" class="hidden" style="color: var(--text-muted); margin-top: var(--space-md); font-size: 1.1rem; font-style: italic;"></p>
                </div>
                
                <!-- Controls -->
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: auto; padding-top: var(--space-xl);">
                    <button class="btn btn-secondary" onclick="showHint()">ğŸ’¡ Gá»£i Ã½</button>
                    <button class="btn btn-secondary" onclick="skipQuestion()">â­ï¸ Bá» qua</button>
                </div>
            </div>

            <!-- RIGHT COLUMN: Interaction -->
            <div class="glass-panel" style="display: flex; flex-direction: column; justify-content: center; min-height: 400px; padding: var(--space-xl);">
                
                <!-- Main Action Area -->
                <div style="text-align: center; margin-bottom: var(--space-lg);">
                    
                    <!-- Noise Calibration -->
                    <div style="margin-bottom: var(--space-md);">
                        <button class="btn btn-secondary btn-sm" onclick="calibrateNoise()" style="font-size: 0.85rem;">ğŸ”Š Hiá»‡u chá»‰nh tiáº¿ng á»“n</button>
                        <div style="margin-top: 8px;">
                            <div style="width: 100%; height: 6px; background: var(--bg-card); border-radius: 3px; overflow: hidden;">
                                <div id="volumeMeter" style="width: 0%; height: 100%; background: var(--gradient-primary); transition: width 0.1s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visualizer Canvas -->
                    <canvas id="quizVisualizer" width="300" height="100" style="width: 100%; height: 100px; margin-bottom: var(--space-lg);"></canvas>
                    
                    <!-- Record Button -->
                    <button id="quizRecordBtn" class="btn btn-primary btn-icon" style="width: 120px; height: 120px; font-size: 3rem; border-radius: 50%; box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);" onclick="toggleQuizRecording()">
                        ğŸ¤
                    </button>
                    <p id="quizRecordStatus" style="color: var(--text-muted); margin-top: var(--space-md); font-weight: 500;">Nháº¥n Ä‘á»ƒ báº¯t Ä‘áº§u nÃ³i</p>
                </div>

                <!-- User Answer & Result -->
                <div id="quizResultWrapper" class="hidden" style="animation: slideUp 0.3s ease;">
                    <div style="background: var(--bg-card); border-radius: 12px; padding: var(--space-md); margin-bottom: var(--space-md);">
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Báº¡n nÃ³i:</p>
                        <p id="quizUserAnswer" style="font-size: 1.25rem; font-weight: 600; color: var(--primary-text);"></p>
                    </div>

                    <!-- Analysis Result -->
                    <div id="quizResultArea" class="hidden text-center">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: var(--space-sm);">
                            <span id="quizResultIcon" style="font-size: 2.5rem;"></span>
                            <span id="quizResultText" style="font-size: 1.5rem; font-weight: 700;"></span>
                        </div>
                        <div id="quizCorrectAnswer" style="text-align: left; background: rgba(0,0,0,0.2); padding: var(--space-md); border-radius: 8px;"></div>
                        <div style="display: flex; gap: 10px; margin-top: var(--space-md);">
                            <button id="quizRetryBtn" class="btn btn-secondary hidden" style="flex: 1;" onclick="retryQuizQuestion()">ğŸ”„ Thá»­ láº¡i (<span id="quizRetryCount">2</span>)</button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="nextQuizQuestion()">CÃ¢u tiáº¿p theo â¡ï¸</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Score Summary (Overlay or replace content) -->
        <div id="quizScoreSummary" class="hidden card" style="margin-top: var(--space-2xl); padding: var(--space-xl); text-align: center;">
            <h3 class="mb-3">ğŸ“Š Káº¿t quáº£ bÃ i kiá»ƒm tra</h3>
            <div style="display: flex; justify-content: center; gap: var(--space-2xl);">
                <div>
                    <p style="font-size: 3rem; font-weight: 700; color: var(--accent-green);" id="correctCount">0</p>
                    <p style="color: var(--text-muted);">ÄÃºng</p>
                </div>
                <div>
                    <p style="font-size: 3rem; font-weight: 700; color: var(--accent-pink);" id="wrongCount">0</p>
                    <p style="color: var(--text-muted);">Sai</p>
                </div>
            </div>
            <button class="btn btn-primary mt-3" onclick="restartQuiz()">ğŸ”„ LÃ m láº¡i</button>
        </div>
    </div>

    <!-- Practice Area -->
    <div id="practiceArea" class="hidden">
        <div class="glass-panel text-center" style="max-width: 800px; margin: 0 auto; padding: var(--space-xl);">
            <!-- Settings -->
            <div id="practiceSettings">
                <h2 class="text-gradient mb-4">âœï¸ Luyá»‡n táº­p tá»« vá»±ng</h2>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: var(--space-xl);">
                    <select id="practiceLevel" class="input-field" style="width: auto;">
                        <option value="Elementary">SÆ¡ cáº¥p</option>
                        <option value="Intermediate">Trung cáº¥p</option>
                        <option value="Advanced">Cao cáº¥p</option>
                    </select>
                    <select id="practiceType" class="input-field" style="width: auto;">
                        <option value="fill_blank">Äiá»n tá»« vÃ o chá»— trá»‘ng</option>
                        <option value="arrange">Sáº¯p xáº¿p cÃ¢u</option>
                        <option value="translate">BiÃªn dá»‹ch</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="startPractice()">Báº¯t Ä‘áº§u luyá»‡n táº­p</button>
            </div>

            <!-- Loading -->
            <div id="practiceLoading" class="hidden">
                <div class="spinner" style="margin: 0 auto var(--space-lg);"></div>
                <p style="color: var(--text-muted);">Äang táº¡o bÃ i táº­p...</p>
            </div>

            <!-- Quiz Interface -->
            <div id="practiceQuiz" class="hidden">
                <div style="margin-bottom: var(--space-lg);">
                    <span style="color: var(--text-secondary);">CÃ¢u há»i</span>
                    <span id="practiceCurrentIndex" style="font-size: 1.5rem; font-weight: 600; color: var(--primary-light);">1</span>
                    <span style="color: var(--text-muted);"> / </span>
                    <span id="practiceTotalCount" style="font-size: 1.5rem; color: var(--text-muted);">5</span>
                </div>

                <!-- Score -->
                <div style="position: absolute; top: var(--space-md); right: var(--space-md); background: rgba(0,0,0,0.2); padding: 5px 10px; border-radius: 20px;">
                    Correct: <span id="practiceScore" style="color: var(--accent-green); font-weight: bold;">0</span>
                </div>

                <div class="card" style="margin-bottom: var(--space-xl); min-height: 150px; display: flex; align-items: center; justify-content: center;">
                    <p id="practiceQuestion" style="font-size: 1.5rem; font-weight: 500; text-align: center;"></p>
                </div>

                <!-- Input Area (Dynamic based on type) -->
                <div id="practiceInputArea" style="margin-bottom: var(--space-xl);">
                    <!-- Multiple Choice / Fill Blank -->
                    <div id="practiceOptions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;" class="hidden"></div>
                    
                    <!-- Arrange Words -->
                    <div id="practiceArrange" class="hidden">
                        <div id="practiceArrangeSource" style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-bottom: 1rem; min-height: 50px; border: 1px dashed var(--border-glass); padding: 10px; border-radius: 8px;"></div>
                        <p style="color: var(--text-muted); font-size: 0.9rem;">Nháº¥n vÃ o tá»« Ä‘á»ƒ sáº¯p xáº¿p</p>
                        <div id="practiceArrangeTarget" style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; min-height: 50px; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 8px;"></div>
                    </div>

                    <!-- Text Input (Translate) -->
                    <div id="practiceTranslate" class="hidden">
                        <textarea id="practiceTranslateInput" class="input-field" rows="3" placeholder="Nháº­p cÃ¢u dá»‹ch..."></textarea>
                    </div>
                </div>

                <!-- Feedback Area -->
                <div id="practiceFeedback" class="hidden" style="margin-bottom: var(--space-lg); padding: var(--space-md); border-radius: 8px;">
                    <p id="practiceFeedbackText" style="font-weight: 600; font-size: 1.2rem;"></p>
                    <p id="practiceExplanation" style="color: var(--text-secondary); margin-top: 5px;"></p>
                </div>

                <!-- Controls -->
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button id="practiceCheckBtn" class="btn btn-primary" onclick="checkPracticeAnswer()">Kiá»ƒm tra</button>
                    <button id="practiceNextBtn" class="btn btn-secondary hidden" onclick="nextPracticeQuestion()">CÃ¢u tiáº¿p theo â¡ï¸</button>
                </div>
            </div>

            <!-- Summary -->
            <div id="practiceSummary" class="hidden">
                <h3 class="mb-3">ğŸ‰ HoÃ n thÃ nh!</h3>
                <p style="font-size: 1.2rem; margin-bottom: var(--space-lg);">Báº¡n tráº£ lá»i Ä‘Ãºng <span id="practiceFinalScore" style="color: var(--accent-green); font-weight: bold;"></span> cÃ¢u.</p>
                <button class="btn btn-primary" onclick="resetPractice()">LÃ m bÃ i khÃ¡c</button>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="card text-center" style="padding: var(--space-3xl);">
        <p style="font-size: 3rem;">ğŸ“š</p>
        <p style="color: var(--text-muted);">Chá»n chá»§ Ä‘á» hoáº·c táº£i file Ä‘á»ƒ báº¯t Ä‘áº§u há»c</p>
    </div>
    
    <!-- Spacing for bottom -->
    <div style="height: 100px;"></div>
</div>

<style>
    .mode-btn.active {
        background: var(--gradient-primary) !important;
        color: white !important;
    }
</style>

@section Scripts {
<script src="~/js/audioProcessor.js" asp-append-version="true"></script>
<script src="~/js/vocabulary.js" asp-append-version="true"></script>
<script>
    async function calibrateNoise() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'ğŸ”„ Äang hiá»‡u chá»‰nh...';
        btn.disabled = true;
        
        try {
            if (!window.audioNoiseGate) {
                await initNoiseGate();
            }
            
            // Start monitoring to show volume
            window.audioNoiseGate.startMonitoring((volume) => {
                const meter = document.getElementById('volumeMeter');
                if (meter) meter.style.width = Math.min(volume, 100) + '%';
            });
            
            // Calibrate for 2 seconds
            const threshold = await window.audioNoiseGate.calibrateNoiseFloor(2000);
            
            window.audioNoiseGate.stopMonitoring();
            btn.textContent = `âœ… NgÆ°á»¡ng: ${threshold}`;
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        } catch (e) {
            console.error('Calibration error:', e);
            btn.textContent = 'âŒ Lá»—i';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 2000);
        }
    }
</script>
}
